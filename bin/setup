#!/usr/bin/env ruby

require "fileutils"

# path to your application root.
APP_ROOT = File.expand_path("..", __dir__)

def system!(*args)
  system(*args) || abort("\n== Command #{args} failed ==")
end

#
# Prints the log message with a yellow color to distinguish logs
# See more information here - https://stackoverflow.com/questions/1489183/how-can-i-use-ruby-to-colorize-the-text-output-to-a-terminal
#
def log(message)
  printf "\033[1;33m";

  puts "\n[ bin/setup ] #{message}"

  printf "\033[0m"
end


FileUtils.chdir APP_ROOT do
  log "---------------------"
  log "❤️  Setup started... ❤️"
  log "---------------------"

  #
  # Validate that the ruby version requirement is met.
  #
  expected_version = `cat .ruby-version`.chomp
  current_version = `ruby -v`.chomp
  unless current_version.include?(expected_version)
    log "Ruby version must be #{expected_version}. You are on #{current_version}"
    exit
  end

  log "== Installing dependencies =="
  system! "gem install foreman"
  system! "gem install bundler --conservative"
  system!("bundle check") || system!("bundle install")

  # Install JavaScript dependencies if using Yarn
  log '== Installing javascript dependencies via yarn == '
  system('bin/yarn')

  unless File.exist?('.env')
    log "== Setup .env file from .env.example =="
    system!('cp .env.example .env')
  end

  log "== Preparing database =="
  log "⚠️  If you use docker to run postgres, make sure your database is running ⚠️"
  system! 'bin/rails db:drop db:create db:migrate'
  system! 'bin/rails db:seed'

  log "== Removing old logs, tempfiles, and jobs =="
  system! 'bin/rails log:clear tmp:clear jobs:clear'

  log "== Restarting application server =="
  system! 'bin/rails restart'

  log "== Precompiling assets =="
  system! 'bin/rails assets:precompile'

  log "---------------------"
  log "❤️  Done! Run bin/start to run the application locally at http://localhost:3000 ❤️"
  log "---------------------"
end
